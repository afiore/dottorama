(function(){var q,m,n,s,t,l,r,o,u,v=Array.prototype.slice,w=this,x=Object.prototype.hasOwnProperty,p=function(c,b){function d(){this.constructor=c}for(var a in b)x.call(b,a)&&(c[a]=b[a]);d.prototype=b.prototype;c.prototype=new d;c.__super__=b.prototype;return c};m=function(c){var b;b=Q.defer();d3.json(c,function(d){return b.resolve(d)});return b.promise};q=r=null;this.app={api:{fetchDistributionAverage:function(c){null==c&&(c=19);return(q&&Q.call(function(){return q})||m("/data/_average_distributions.json")).then(function(b){var d,
a;q=b;return _.max(function(){var c;c=[];for(d in b)a=b[d][0],c.push(a);return c}())})},fetchDistributions:function(c){null==c&&(c=19);return m("/data/distributions.json").then(function(b){return{name:"Root",children:b}})},fetchOccurencies:function(c,b){null==b&&(b=19);return this._fetchOccurencyAverages(b).then(function(d){c=encodeURIComponent(c.replace(/\//g,"-"));return m("/data/"+c+"_co-occurrencies.json").then(function(a){return[a[b.toString()],d]})})},_fetchOccurencyAverages:function(c){null==
c&&(c=19);return(r&&Q.call(function(){return r})||m("/data/_average_co-occurencies.json")).then(function(b){r=b;return b[c]})}}};this.app.__defineGetter__("ciclo",function(){return this._ciclo||"19"});this.app.__defineSetter__("ciclo",function(c){return this._ciclo=c});s=function(c){return c.__data__};this.app.Delegator=function(){function c(b,d){this.element=b;this.options=null!=d?d:{};"string"===typeof this.element&&(this.element=document.querySelector(this.element));this.bindEvents()}c.prototype.bindEvents=
function(){var b,d,a,c,e,j,f,g;if(this.events){j=this.events;g=[];for(a in j)d=j[a],f=a.split(" "),c=2<=f.length?v.call(f,0,e=f.length-1):(e=0,[]),b=f[e++],g.push(this.addEvent(c.join(" "),b,d));return g}};c.prototype.addEvent=function(b,d,a){var c,e=this;c=function(){return e[a].apply(e,arguments)};return this.element.addEventListener(d,function(a){if(_.include(e.element.querySelectorAll(b),a.target))return c(a,s(a.target))})};return c}();app.utils={applyAll:function(c,b,d){null==d&&(d=null);return _.each(c,
function(a){return a.apply(d||w,b)})}};this.app.Slider=function(c){function b(d,a){b.__super__.constructor.call(this,d,a);this.graph=a.graph}p(b,c);b.prototype.events={mouseup:"onMouseUp"};b.prototype.onMouseUp=function(d){d.target.parentElement.querySelector("output").value=d.target.value;app.ciclo=d.target.value;return this.graph.update()};return b}(this.app.Delegator);n=function(c){for(;c.parent&&"Root"!==c.parent.name;)c=c.parent;return c};u=function(c){c.fill0=d3.select(this).style("fill");c.x0=
c.x;return c.dx0=c.dx};o=function(c){var b;return(null!=c?null!=(b=c.frequencies)?b[app.ciclo]:void 0:void 0)||0};this.app.SunburstGraph=function(c){function b(d,a,c){this.data=d;this.element=null!=a?a:"#chart";this.options=null!=c?c:{};_.defaults(this.options,{width:700,height:700});d=Math.min(this.options.width,this.options.height)/2;this.vis=d3.select(this.element).append("svg").attr("width",this.options.width).attr("height",this.options.height).append("g").attr("transform","translate("+this.options.width/
2+","+this.options.height/2+")");this.partition=d3.layout.partition().sort(function(a,d){var b;return(null!=d?null!=(b=d.frequencies)?b[app.ciclo]:NaN:NaN)-a.frequencies[app.ciclo]||1}).size([2*Math.PI,d*d]).value(o);this.arc=d3.svg.arc().startAngle(function(a){return a.x}).endAngle(function(a){return a.x+a.dx}).innerRadius(function(a){return Math.sqrt(a.y)}).outerRadius(function(a){return Math.sqrt(a.y+a.dy)});this.tooltip=new app.Tooltip({graph:this});this.barchartPanel=this.options.barchartPanel;
this.setColourScales();b.__super__.constructor.call(this,this.element,this.options)}p(b,c);b.prototype.events={"path mouseover":"onMouseover","path mouseout":"onMouseout","path click":"onClick","path mousemove":"onMousemove"};b.prototype.render=function(){var d=this;this.vis.data([this.data]).selectAll("path").data(this.partition.nodes).enter().append("g");this.vis.selectAll("g").append("path").attr("display",function(a){return a.depth&&3>a.depth?null:"none"}).attr("d",this.arc).attr("fill-rule",
"evenodd").style("stroke","#fff").style("fill",function(a){if(0<a.depth)return a=n(a),"hsl(0, 0%, "+d.colourScales.level(a.frequencies[app.ciclo])+"%)"}).each(u);return this};b.prototype.setColourScales=function(){var d,a,b,c;b=function(){var d,b,c,e;c=this.data.children;e=[];for(d=0,b=c.length;d<b;d++)a=c[d].name,e.push(a);return e}.call(this);c=function(){var a,b,c,e;c=this.data.children;e=[];for(a=0,b=c.length;a<b;a++)d=c[a],e.push(o(d));return e}.call(this).sort(function(a,d){return d-a});return this.colourScales=
{hue:d3.scale.ordinal().domain(b).rangePoints([0,359]),level:d3.scale.ordinal().domain(c).rangeRoundBands([0,100])}};b.prototype.update=function(){var d=this;this.setColourScales();return this.vis.selectAll("path").data(this.partition.value(o)).transition().duration(1E3).style("fill",function(a){a=n(a);return"hsl(0, 0%, "+d.colourScales.level(o(a))+"%)"}).attrTween("d",function(a){var b;b=d3.interpolate({x:a.x0,dx:a.dx0},a);return function(c){c=b(c);a.x0=c.x;a.dx0=c.dx;return d.arc(c)}})};b.prototype.onMouseover=
function(d,a){a.active||this._colouriseSector(a);return this.tooltip.show(a)};b.prototype.onMouseout=function(d,a){a.active||this._downlightSector(a);return this.tooltip.hide()};b.prototype.onClick=function(d,a){var b=this;this._downlightAll();return this._fetchRelatedSectors(a).then(function(d){var c;c=_.clone(a);c.colour=d3.hsl(b.colourScales.hue(a.parent.name),1,0.5).toString();b.barchartPanel.clear().render(c,d);return null},function(a){throw a;})};b.prototype.onMousemove=function(d){return this.tooltip.move(d)};
b.prototype._colouriseSector=function(d){var a;a=n(d);1===d.depth&&(d=a);a=d3.hsl(this.colourScales.hue(a.name),1,0.5);this.vis.selectAll("path").filter(function(a){return a===d||a.parent===d}).style("fill",a.toString());return this};b.prototype._downlightSector=function(d){this.vis.selectAll("path").filter(function(a){return a===d||a.parent===d}).style("fill",function(a){return a.fill0});return this};b.prototype._downlightAll=function(){this.vis.selectAll("path").style("fill",function(d){return d.fill0});
return this};b.prototype._fetchRelatedSectors=function(d){var a=this;return app.api.fetchOccurencies(d.name,app.ciclo).then(function(d){var b,c,f,g,k,h,i;k=[];f=d[0];b=d[1];h=function(){var a;a=[];for(i in f)c=f[i],c>=b&&a.push([i,c]);return a}();g=function(){var a,d,b,e;e=[];for(a=0,d=h.length;a<d;a++)b=h[a],i=b[0],c=b[1],e.push(i);return e}();a.vis.selectAll("path").filter(function(a){return-1<g.indexOf(a.name)}).style("fill",function(d){var b;b=n(d);b=d3.hsl(a.colourScales.hue(b.name),1,0.5).toString();
k.push({colour:b,name:d.name,frequencies:d.frequencies,co_occurencies:f[d.name]});return b}).each(function(a){return a.active=!0});return k})};return b}(this.app.Delegator);l=null;t=function(c){var b,d,a;d=c.frequencies;a=[];for(b in d)c=d[b],a.push(c);return a};this.app.Barchart=function(c){function b(d,a){null==a&&(a={});_.defaults(a,{height:30,bar_width:30,colour:"grey"});l=d3.scale.linear().domain([0,parseInt(a.maxSectorFrequency)]).rangeRound([0,a.height]);this.selection=d3.select(d).append("g").attr("class",
"barchart");b.__super__.constructor.call(this,this.selection.node(),a)}p(b,c);b.prototype.render=function(d){var a,b,c=this;a=t(d);b=[];this.selection.selectAll("rect").data(a).enter().append("rect").attr("x",function(a,b){return b*c.options.bar_width}).attr("y",function(a){return c.options.y+c.options.height-l(a)}).attr("width",this.options.bar_width).attr("height",function(a){a=l(a);b.push(a);return a}).style("stroke","none");this.selection.append("rect").attr("x",function(){return(app.ciclo-19)*
c.options.bar_width}).attr("y",function(){return c.options.y+c.options.height-l(d.co_occurencies)}).attr("width",this.options.bar_width).attr("height",function(){return l(d.co_occurencies)}).style("fill",this.options.sector.colour).style("stroke","none");this.selection.append("text").attr("x",function(){return a.length*c.options.bar_width+10}).attr("y",function(){return c.options.y}).append("tspan").text(d.name).style("font-size",12).style("fill","#fff").node();this.selection.append("rect").attr("height",
18).attr("width",function(){return 10*d.name.trim().length}).attr("x",function(){return a.length*c.options.bar_width+8}).attr("y",function(){return c.options.y+25}).style("fill",d.colour);return this};b.prototype.remove=function(){return this.element.parentElement.removeChild(this.element)};return b}(this.app.Delegator);this.app.BarchartPanel=function(c){function b(d,a){_.defaults(a,{height:700,width:700,barchart_height:40,barchart_bar_width:20});this.selection=d3.select(d).append("svg").attr("width",
a.width).attr("height",a.height);this.charts=[];b.__super__.constructor.call(this,this.selection.node(),a)}p(b,c);b.prototype.render=function(b,a){var c,e,j,f,g,k,h,i,a=a.sort(function(a,b){return b.frequencies[app.ciclo]-a.frequencies[app.ciclo]});e=Math.round(this.options.height/this.options.barchart_height);k=function(){var a,b;b=[];for(f=0,a=e-1;0<=a?f<=a:f>=a;0<=a?f++:f--)b.push(this.options.barchart_height*f);return b}.call(this);c={height:this.options.barchart_height,bar_width:this.options.barchart_bar_width,
maxSectorFrequency:this.options.maxSectorFrequency,sector:b};for(h=0,i=k.length;h<i;h++)g=k[h],this.charts.push(new app.Barchart(this.element,_.extend({y:g},c)));for(j in a)c=a[j],this.charts[j].render(c);return this};b.prototype.clear=function(){var b,a,c,e;e=this.charts;for(a=0,c=e.length;a<c;a++)b=e[a],b.remove();this.charts=[];return this};return b}(this.app.Delegator);this.app.Tooltip=function(c){function b(c){null==c&&(c={});this.selection=d3.select("body").append("div").attr("class","tooltip");
this.graph=c.grap;b.__super__.constructor.call(this,this.selection.node(),c)}p(b,c);b.prototype.show=function(b){var a,c;c=b.human_name||b.name;c+=" ( "+(null!=b?null!=(a=b.frequencies)?a[app.ciclo]:void 0:void 0)+")";a=1===b.depth&&b||(null!=b?b.parent:void 0);1===b.depth&&(b=a);a=d3.hsl(this.options.graph.colourScales.hue(a.name),1,0.5);b&&c&&this.selection.text(c).style("visibility","visible").style("background",a.toString());return this};b.prototype.hide=function(){this.selection.style("visibility",
"hidden");return this};b.prototype.move=function(b){this.selection.style("top",b.pageY-10+"px").style("left",b.pageX+10+"px");return this};return b}(this.app.Delegator);document.addEventListener("DOMContentLoaded",function(){return app.api.fetchDistributions().then(function(c){app.api.fetchDistributionAverage(19).then(function(b){b=new app.BarchartPanel("#barchart-panel",{maxSectorFrequency:b});b=(new app.SunburstGraph(c,"#chart",{barchartPanel:b})).render();new app.Slider("#ciclo-slider",b);return null},
function(b){throw b;}).end();return c},function(c){throw c;}).end()})}).call(this);
